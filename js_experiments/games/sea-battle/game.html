<!DOCTYPE html>
<html lang="ru">

<head>
	<meta charset="utf-8">

	<title>Sea Battle</title>
	<meta name="description" content="">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	
	<!-- Template Basic Images Start -->
	<meta property="og:image" content="path/to/image.jpg">
<!-- 	<link rel="icon" href="img/favicon/favicon.ico">
	<link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-touch-icon-180x180.png"> -->
	<!-- Template Basic Images End -->
	
	<!-- Custom Browsers Color Start -->
	<meta name="theme-color" content="#000">
	<!-- Custom Browsers Color End -->

	<!-- Bootstrap CSS -->
    <link rel="stylesheet" href="libs/bootstrap-4.0.0-dist/css/bootstrap-grid.css">

	<!-- Custom CSS -->
<!-- 	<link rel="stylesheet" href="css/main.css"> -->
</head>

<body>
	<!-- Custom HTML -->
	<div class="container">
		<div class="row justify-content-center">
			<div class="col-auto">
				<canvas>
					
				</canvas>
 			</div>
		</div>
	</div>



	<script type="text/javascript" src="pointjs_0.2.0.0_demo.js"></script>

	<script	type="text/javascript">

		'use strict'

		var pjs = new PointJS('2d', 800, 600);
		pjs.system.initFullPage();

		var game = pjs.game;
		var key = pjs.keyControl;
		var vector = pjs.vector;		
		var point = vector.point;


		var log = pjs.system.log;

		var size = vector.size;
		var camera = pjs.camera;
		var brush = pjs.brush;
		var OOP = pjs.OOP;
		var rand = pjs.math.random;
 
		var height = game.getWH().h;
		var width = game.getWH().w;


		key.initControl();

		var sea1 = game.newImageObject({
			x : 0, y : 0,
			file : 'asset/bgSea2.png',
			h : height,
			onload : function(){
				sea2.x = sea1.x+sea1.w
			}
		})		
		var sea2 = game.newImageObject({
			x : sea1.x+sea1.w, y : 0,
			file : 'asset/bgSea2.png',
			h : height
		})		
		var sky1 = game.newImageObject({
			x : 0, y : 0,
			file : 'asset/bgSky2.png',
			h : height,
			onload : function(){
				sky2.x = sky1.x+sky1.w
			}			
		})		
		var sky2 = game.newImageObject({
			x : sky1.x+sky1.w, y : 0,
			file : 'asset/bgSky2.png',
			h : height			
		})		
		var mySubmarine = game.newAnimationObject({
			x : 50, y : 300,
			h : 45, w : 78,
			delay : -5,
			animation : pjs.tiles.newAnimation('asset/submarine.png', 78, 45, 9)			
		})

		var moveBackGround = function(s){
			sea1.move(point(-s, 0));
			sea2.move(point(-s, 0));

			sky1.move(point(-s/2, 0));
			sky2.move(point(-s/2, 0));

			if (sea1.x + sea1.w < 0){
				sea1.x = sea2.x + sea2.w;
			}
			if (sea2.x + sea2.w < 0){
				sea2.x = sea1.x + sea1.w;
			}			
			if (sky1.x + sky1.w < 0){
				sky1.x = sky2.x + sky2.w;
			}
			if (sky2.x + sky2.w < 0){
				sky2.x = sky1.x + sky1.w;
			}			
		};

		var enemys = [];
		var t = 8000;
		var idInt;

		var generateEnemys = function(){
			idInt = setInterval(function() {
				enemys.push(
					game.newAnimationObject({
						x : width, 
						y : rand(height - (height - 86), height-80),
						h : 45, w : 78,
						delay : -5,
						animation : pjs.tiles.newAnimation('asset/enemys.png', 78, 45, 9),
					}));
			}, t);
		}    //var generateEnemys = function()


		var torpeds = [];

		var shoot = function(){
			torpeds.push(
				game.newImageObject({
				x : mySubmarine.x + mySubmarine.w / 4, 
				y : mySubmarine.y + mySubmarine.h / 1.6 ,
				file : 'asset/torpedo.png',
			}));
		};

		// Игровой цикл 'menu' ======================================

		game.newLoop('menu', function(){
			sea1.draw();
			sea2.draw();

			sky1.draw();
			sky2.draw();

			mySubmarine.draw();

			mySubmarine.x = 50;
			mySubmarine.y = 300;

			pjs.brush.drawText({
				text : "Для старта нажмите ENTER",
				font : "roboto", 
				x : 20, y : 20, 
				color : "black",
				size : 25
			});
			pjs.brush.drawText({
				text : "Управление: клавишами A D W S или стрелками",
				font : "roboto", 
				x : 20, y : 60, 
				color : "black",
				size : 25
			});

			if (key.isDown('ENTER')){
				enemys = [];
				torpeds = [];
				// DX = 0;
				// DY = 0;
				generateEnemys();
				game.setLoop('game');
			}



		});	// Закончился игровой цикл 'menu'	



		

		// Игровой цикл 'game' ======================================


		game.newLoop('game', function(){

			//  блок управления

			if (key.isDown('ESC')){
				clearInterval(idInt);
				game.setLoop('menu');
			}
			if (key.isPress('SPACE')){
				shoot();
			}
			if (key.isDown('LEFT') || key.isDown('A')){
				mySubmarine.move(point(-2, 0));
			}			
			if (key.isDown('UP') || key.isDown('W')){
				mySubmarine.move(point(0, -2));
			}			
			if (key.isDown('DOWN') || key.isDown('S')){
				mySubmarine.move(point(0, 2));
			}
			if (key.isDown('RIGHT') || key.isDown('D')){
				mySubmarine.move(point(2, 0));
			}

			sea1.draw();
			sea2.draw();
			sky1.draw();
			sky2.draw();
			moveBackGround(2);


			// ограничение перемещения по экрану

			if (mySubmarine.y <= (height - (height - 86))){
				// pjs.brush.drawText({
				// text : "Лодки не летают",
				// font : "roboto", 
				// x : 20, y : 40, 
				// color : "black",
				// size : 25
				// });
				mySubmarine.y = height - (height - 86);				
			}
			if (mySubmarine.y >= height-80){
				// pjs.brush.drawText({
				// text : "Там уже дно",
				// font : "roboto", 
				// x : 20, y : 40, 
				// color : "black",
				// size : 25
				// });
				mySubmarine.y = height-80;				
			}
			if (mySubmarine.x < 0){
				// pjs.brush.drawText({
				// text : "Туда нельзя",
				// font : "roboto", 
				// x : 20, y : 40, 
				// color : "black",
				// size : 25
				// });
				mySubmarine.x = 0;				
			}
			if (mySubmarine.x >= width - mySubmarine.w){
				// pjs.brush.drawText({
				// text : "Туда нельзя",
				// font : "roboto", 
				// x : 20, y : 40, 
				// color : "black",
				// size : 25
				// });
				mySubmarine.x = width - mySubmarine.w;				
			}



			//  отрисовка противников


			for (var j in enemys) {
				enemys[j].x -= 2.2;

				// if (enemys[j] != null && torpeds[i] != null) {

				// 	if (enemys[j].isIntersect(torpeds[i])){
				// 		enemys.shift();
				// 	}
				// }

				if (enemys[j].x + enemys[j].w < 0){
					enemys.shift();
				}


				if (enemys[j] != null ) {
					enemys[j].draw();
				}


				if (mySubmarine.isIntersect(enemys[j])){
					game.setLoop('menu');
				}

			
			}

			//  отрисовка торпед

			for (var i in torpeds){
				torpeds[i].x += 3;
				torpeds[i].rotateForAngle(180, 1000);


				if (torpeds[i].x > width){
					torpeds.shift();
				}	

				if (enemys[j] != null && torpeds[i] != null) {

					if (torpeds[i].isIntersect(enemys[j])){
						torpeds.shift();
						enemys.shift();
					}
				}

				if (torpeds[i] != null ) {
					torpeds[i].draw();
				}
			}

			// if (enemys[j] != null && torpeds[i] != null) {

			// 	if (enemys[j].isIntersect(torpeds[i])){
			// 		console.log('Babah')
			// 		enemys.shift();
			// 	}
			// }
			
			mySubmarine.draw();




		});		// Закончился игровой цикл 'game'



		game.setLoop('menu');
		game.start();
		



	</script>
</body>
</html>